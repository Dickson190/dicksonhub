<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw</title>
    <link rel="stylesheet" href="withdraw.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="sidenav.css">
    <style>
 
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Side Navigation -->
        <div id="sidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="toggleNav()">&times;</a>
            <a href="app.html">Home</a>
            <a href="earn.html">Offerwall</a>
            <a href="task.html">Task</a>
            <a href="bean.html" class="active">Upgrade Account</a>
            <a href="shop.html">Shop</a>
            <a href="news.html">New Features/Updates</a>
            <a href="withdraw.html">Withdraw</a>
            <a href="whistory.html">Withdrawal History</a>
             <a href="conversion.html">Convert Airtime/Data </a>
            <a href="about.html">About Us</a>
        </div>

        <a href="javascript:void(0);" class="icon" onclick="toggleNav()">
            <i class="fa fa-bars"></i>
        </a>
    
        <div class="withdraw-container">
            <h1>Withdraw Funds</h1>
            <form id="withdrawForm" method="post">
                <input type="hidden" name="_next" value="https://dickson190.github.io/dicksonhub/whistory.html">

                <label for="withdrawalType">Withdrawal Type</label>
                <select id="withdrawalType" name="data[type]" required>
                    <option value="airtime">Airtime</option>
                    <option value="bank">Bank Transfer</option>
                </select>
                
                <!-- Airtime Withdrawal Fields -->
                <div id="airtimeFields" style="display:none;">
                    <label for="nameAirtime">Name</label>
                    <input type="text" id="nameAirtime" name="data[Aname]" required />
                    
                    <label for="network">Network</label>
                    <input type="text" id="network" name="data[network]" readonly/>
                    
                    <label for="phoneNumber">Phone Number</label>
                    <input type="text" id="phoneNumber" name="data[phoneNumber]" readonly/>
                    
                    <label for="uniqueCode">Unique Code</label>
                    <input type="text" id="uniqueCode" name="data[uniqueCode]" readonly />
                    
                    <label for="amountAirtime">Amount</label>
                    <input type="number" id="amountAirtime" name="data[Aamount]" required />
                </div>
                
                <!-- Bank Transfer Withdrawal Fields -->
                <div id="bankFields" style="display:none;">
                    <p class="instruction">Note: A 10% fee will be charged for bank transfers.</p>
                    
                    <label for="nameBank">Name</label>
                    <input type="text" id="nameBank" name="data[name]" required />
            
                    <label for="bankName">Bank Name</label>
                    <input type="text" id="bankName" name="data[bankName]" />
                    
                    <label for="accountName">Account Name</label>
                    <input type="text" id="accountName" name="data[accountName]" />
                    
                    <label for="accountNumber">Account Number</label>
                    <input type="text" id="accountNumber" name="data[accountNumber]" />
                    
                    <label for="amountBank">Amount</label>
                    <input type="number" id="amountBank" name="data[amount]" required />
                </div>
                
                <button type="submit">Withdraw!</button>
            </form>
        </div>

        <div id="popup-success" class="popup">
            <div class="checkmark">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle cx="26" cy="26" r="25" fill="none" />
                    <path fill="none" stroke="#22c55e" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" d="M14 27l8 8 16-16" />
                </svg>
            </div>
            <h2>Withdrawal placed successfully</h2>
            <button onclick="handleOk()">OK</button>
        </div>

        <div id="popup-error" class="popup">
            <h2>Withdrawal failed. Please try again.</h2>
            <button onclick="handleError()">OK</button>
        </div>
       <div id="notification-container"></div>
        <script src="sidenav.js"></script>    
        <script>
      document.addEventListener('DOMContentLoaded', function () {
    const withdrawalTypeElement = document.getElementById('withdrawalType');
    const airtimeFields = document.getElementById('airtimeFields');
    const bankFields = document.getElementById('bankFields');
    const withdrawForm = document.getElementById('withdrawForm');
    const notificationContainer = document.getElementById('notification-container');

    const userPhoneNumber = localStorage.getItem('phoneNumber');
    const currentUser = localStorage.getItem('username');
    const currentPassword = localStorage.getItem('password');
    let userEarnings = parseFloat(localStorage.getItem(`${userPhoneNumber}_${currentUser}_${currentPassword}_earnings`)) || 0;

    const activeCardKey = `${userPhoneNumber}_${currentUser}_${currentPassword}_activeCard`;
    const activeCard = JSON.parse(localStorage.getItem(activeCardKey));

    // Threshold settings based on membership plan
    const thresholdMap = {
        'Free Membership': 200,
        'Bronze Membership': 100,
        'Premium Membership': 50,
        'Gold Membership': 50
    };
    
    // Retrieve stored user details for Airtime and Bank fields
    document.getElementById('network').value = localStorage.getItem('network') || '';
    document.getElementById('phoneNumber').value = localStorage.getItem('phoneNumber') || '';
    document.getElementById('uniqueCode').value = localStorage.getItem('uniqueCode') || '';
    document.getElementById('bankName').value = localStorage.getItem('bankName') || '';
    document.getElementById('accountName').value = localStorage.getItem('accountName') || '';
    document.getElementById('accountNumber').value = localStorage.getItem('accountNumber') || '';

    function toggleFields() {
        const withdrawalType = withdrawalTypeElement.value;
        const airtimeInputs = airtimeFields.querySelectorAll('input');
        const bankInputs = bankFields.querySelectorAll('input');

        if (withdrawalType === 'airtime') {
            airtimeFields.style.display = 'block';
            bankFields.style.display = 'none';
            airtimeInputs.forEach(input => input.required = true);
            bankInputs.forEach(input => input.required = false);
        } else if (withdrawalType === 'bank') {
            airtimeFields.style.display = 'none';
            bankFields.style.display = 'block';
            airtimeInputs.forEach(input => input.required = false);
            bankInputs.forEach(input => input.required = true);
        }
    }

    withdrawalTypeElement.addEventListener('change', toggleFields);
    toggleFields();

    withdrawForm.addEventListener('submit', function (event) {
        event.preventDefault();
        let amount;
        const withdrawalType = withdrawalTypeElement.value;

        if (withdrawalType === 'airtime') {
            amount = parseFloat(document.getElementById('amountAirtime').value);
        } else if (withdrawalType === 'bank') {
            amount = parseFloat(document.getElementById('amountBank').value);
        }

        if (amount > userEarnings) {
            showNotification('Insufficient funds for withdrawal', 'error');
            return;
        }

        const userPlanName = activeCard ? activeCard.planName : 'Free Membership';
        const threshold = thresholdMap[userPlanName];

        if (amount < threshold) {
            showNotification(`Your plan requires a minimum withdrawal of ₦${threshold}. Please enter a higher amount.`, 'error');
            return;
        }

        const apiUrl = "https://sheetdb.io/api/v1/wjwgv7t6ub8mq";
        const secondaryApiUrl = "https://sheetdb.io/api/v1/wjwgv7t6ub8mq";

        const formData = new FormData(withdrawForm);
        const jsonData = {};

        formData.forEach((value, key) => {
            const keys = key.split('[').map(k => k.replace(']', ''));
            if (keys.length > 1) {
                if (!jsonData[keys[0]]) {
                    jsonData[keys[0]] = {};
                }
                jsonData[keys[0]][keys[1]] = value;
            } else {
                jsonData[keys[0]] = value;
            }
        });

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jsonData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.created || data.updated) {
                storeWithdrawalDetails(withdrawalType, amount);
                showNotification('Withdrawal successful!', 'success');
                userEarnings -= amount;
                localStorage.setItem(`${userPhoneNumber}_${currentUser}_${currentPassword}_earnings`, userEarnings.toString());
                setTimeout(() => {
                    window.location.href = 'whistory.html'; // Redirect to the desired page after successful submission
                }, 5000); // Redirect after 5 seconds
            } else {
                throw new Error('Primary API failed');
            }
        })
        .catch(() => {
            fetch(secondaryApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.created || data.updated) {
                    storeWithdrawalDetails(withdrawalType, amount);
                    showNotification('Withdrawal successful!', 'success');
                    userEarnings -= amount;
                    localStorage.setItem(`${userPhoneNumber}_${currentUser}_${currentPassword}_earnings`, userEarnings.toString());
                    setTimeout(() => {
                        window.location.href = 'whistory.html'; // Redirect to the desired page after successful submission
                    }, 5000); // Redirect after 5 seconds
                } else {
                    throw new Error('Secondary API failed');
                }
            })
            .catch(() => {
                showNotification('An error occurred. Please try again later.', 'error');
            });
        });
    });

    function storeWithdrawalDetails(type, amount) {
        const withdrawalHistoryKey = `${userPhoneNumber}_${currentUser}_${currentPassword}_withdrawalHistory`;
        const withdrawalHistory = JSON.parse(localStorage.getItem(withdrawalHistoryKey)) || [];
        const newRecord = {
            time: new Date().toLocaleTimeString(),
            date: new Date().toLocaleDateString(),
            amount: amount,
            status: 'Completed',
            transactionId: 'T' + new Date().getTime(),
            type: type
        };
        withdrawalHistory.push(newRecord);
        localStorage.setItem(withdrawalHistoryKey, JSON.stringify(withdrawalHistory));
    }

    function showNotification(message, type) {
        const notificationBox = document.createElement('div');
        notificationBox.className = `notification ${type}`;
        notificationBox.innerHTML = `
            <div class="notification-content">
                <span class="icon">${type === 'success' ? '✔️' : type === 'error' ? '❌' : 'ℹ️'}</span>
                <span class="message">${message}</span>
                <button class="close-btn" onclick="this.parentElement.parentElement.style.display='none';">OK</button>
            </div>
        `;

        notificationContainer.appendChild(notificationBox);

        notificationBox.style.display = 'block';
        notificationBox.style.animation = 'slideDown 0.5s ease';

        setTimeout(() => {
            notificationBox.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }
});              </script>
    </div>
</body>
</html>

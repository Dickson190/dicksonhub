<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw</title>
    <link rel="stylesheet" href="withdraw.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="sidenav.css">

</head>
<body>
    <div class="mobile-container">
        <!-- Hamburger Icon to Open Sidenav -->
            <span class="icon">
                <i class="fa fa-bars hamburger"></i>
            </span>

        <div class="withdraw-container">
            <h1>Withdraw Funds</h1>
            <div class="instruction" id="instruction">Please be informed that all withdrawals will be paid out within <b>6 - 48 hours</b>. Please also ensure you fill in the form properly. Thank you</div>
            <br>
            <form id="withdrawForm" method="post">
                <input type="hidden" name="_next" value="https://dickson190.github.io/dicksonhub/whistory.html">

                <label for="withdrawalType">Withdrawal Type</label>
                <select id="withdrawalType" name="data[type]" required>
                    <option value="airtime">Airtime</option>
                    <option value="bank">Bank Transfer</option>
                </select>

                <!-- Airtime Withdrawal Fields -->
                <div id="airtimeFields" style="display:none;">
                    <label for="nameAirtime">Name</label>
                    <input type="text" id="nameAirtime" name="data[Aname]" required />

                    <label for="network">Network</label>
                    <input type="text" id="network" name="data[network]" readonly/>

                    <label for="phoneNumber">Phone Number</label>
                    <input type="text" id="phoneNumber" name="data[phoneNumber]" readonly/>

                    <label for="uniqueCode">Unique Code</label>
                    <input type="text" id="uniqueCode" name="data[uniqueCode]" readonly />

                    <label for="amountAirtime">Amount</label>
                    <input type="number" id="amountAirtime" name="data[Aamount]" required />
                </div>

                <!-- Bank Transfer Withdrawal Fields -->
                <div id="bankFields" style="display:none;">
                    <p class="instruction">Note: A 10% fee will be charged for bank transfers.</p>

                    <label for="nameBank">Name</label>
                    <input type="text" id="nameBank" name="data[name]" required />

                    <label for="bankName">Bank Name</label>
                    <input type="text" id="bankName" name="data[bankName]" />

                    <label for="accountName">Account Name</label>
                    <input type="text" id="accountName" name="data[accountName]" />

                    <label for="accountNumber">Account Number</label>
                    <input type="text" id="accountNumber" name="data[accountNumber]" />

                    <label for="amountBank">Amount</label>
                    <input type="number" id="amountBank" name="data[amount]" required />
                </div>

                <button type="submit">Withdraw!</button>
            </form>
        </div>

        <!-- Notifications Container -->
        <div id="notification-container"></div>

        <!-- Success Popup -->
        <div id="popup-success" class="popup" style="display: none;">
            <div class="checkmark">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle cx="26" cy="26" r="25" fill="none" />
                    <path fill="none" stroke="#22c55e" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" d="M14 27l8 8 16-16" />
                </svg>
            </div>
            <h2>Withdrawal placed successfully</h2>
            <button type="button" onclick="handleOk()">OK</button>
        </div>

        <!-- Error Popup -->
        <div id="popup-error" class="popup" style="display: none;">
            <p id="popup-error-message"></p>
            <button type="button" onclick="handleError()">Close</button>
        </div>
    </div>





        <script src="sidenav.js"></script> 
      
<script>
document.addEventListener('DOMContentLoaded', function () {
    const withdrawalTypeElement = document.getElementById('withdrawalType');
    const airtimeFields = document.getElementById('airtimeFields');
    const bankFields = document.getElementById('bankFields');
    const withdrawForm = document.getElementById('withdrawForm');
    const popupSuccess = document.getElementById('popup-success');
    const popupError = document.getElementById('popup-error');
    const popupSuccessMessage = document.getElementById('popup-success-message') || document.createElement('p');
    const popupErrorMessage = document.getElementById('popup-error-message') || document.createElement('p');

    const userPhoneNumber = localStorage.getItem('phoneNumber');
    const currentUser = localStorage.getItem('username');
    const currentPassword = localStorage.getItem('password');
    let userEarnings = parseFloat(localStorage.getItem(`${userPhoneNumber}_${currentUser}_${currentPassword}_earnings`)) || 0;

    const activeCardKey = `${userPhoneNumber}_${currentUser}_${currentPassword}_activeCard`;
    const activeCard = JSON.parse(localStorage.getItem(activeCardKey));
    
    const thresholdMap = {
        'Free Membership': 200,
        'Bronze Membership': 100,
        'Premium Membership': 50,
        'Gold Membership': 50
    };

    document.getElementById('network').value = localStorage.getItem('network') || '';
    document.getElementById('phoneNumber').value = localStorage.getItem('phoneNumber') || '';
    document.getElementById('uniqueCode').value = localStorage.getItem('uniqueCode') || '';
    document.getElementById('bankName').value = localStorage.getItem('bankName') || '';
    document.getElementById('accountName').value = localStorage.getItem('accountName') || '';
    document.getElementById('accountNumber').value = localStorage.getItem('accountNumber') || '';

    function toggleFields() {
        const withdrawalType = withdrawalTypeElement.value;
        const airtimeInputs = airtimeFields.querySelectorAll('input');
        const bankInputs = bankFields.querySelectorAll('input');

        if (withdrawalType === 'airtime') {
            airtimeFields.style.display = 'block';
            bankFields.style.display = 'none';
            airtimeInputs.forEach(input => input.required = true);
            bankInputs.forEach(input => input.required = false);
        } else if (withdrawalType === 'bank') {
            airtimeFields.style.display = 'none';
            bankFields.style.display = 'block';
            airtimeInputs.forEach(input => input.required = false);
            bankInputs.forEach(input => input.required = true);
        }
    }

    withdrawalTypeElement.addEventListener('change', toggleFields);
    toggleFields();

    withdrawForm.addEventListener('submit', function (event) {
        event.preventDefault();
        let amount;
        const withdrawalType = withdrawalTypeElement.value;
        const apiUrl = "https://sheetdb.io/api/v1/wjwgv7t6ub8mq";
        const secondaryApiUrl = "https://sheetdb.io/api/v1/wjwgv7t6ub8mq";

        if (withdrawalType === 'airtime') {
            amount = parseFloat(document.getElementById('amountAirtime').value);
        } else if (withdrawalType === 'bank') {
            amount = parseFloat(document.getElementById('amountBank').value);
        }

        if (amount > userEarnings) {
            console.log('Error: Insufficient funds');
            showPopup('error', 'Insufficient funds for withdrawal.');
            return;
        }

        const userPlanName = activeCard ? activeCard.planName : 'Free Membership';
        const threshold = thresholdMap[userPlanName];

        if (amount < threshold) {
            console.log(`Error: Amount below threshold (${threshold})`);
            showPopup('error', `Your plan requires a minimum withdrawal of â‚¦${threshold}. Please enter a higher amount.`);
            return;
        }

        const formData = new FormData(withdrawForm);

        const withdrawalRecord = {
            time: new Date().toLocaleTimeString(),
            date: new Date().toLocaleDateString(),
            amount: amount,
            status: 'Pending',
            transactionId: Math.random().toString(36).substr(2, 9), // Generate a random transaction ID
            createdAt: new Date().toISOString() // Store timestamp
        };

        // Retrieve or initialize the withdrawal history
        const withdrawalHistoryKey = `${userPhoneNumber}_${currentUser}_${currentPassword}_withdrawalHistory`;
        const withdrawalHistory = JSON.parse(localStorage.getItem(withdrawalHistoryKey)) || [];
        withdrawalHistory.push(withdrawalRecord);
        localStorage.setItem(withdrawalHistoryKey, JSON.stringify(withdrawalHistory));

        console.log('Attempting to send data to primary API...');
        fetch(apiUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Primary API Response:', data);
            if (data.created || data.updated) {
                console.log('Primary API success');
                showPopup('success', 'Withdrawal request submitted successfully.');
                userEarnings -= amount;
                localStorage.setItem(`${userPhoneNumber}_${currentUser}_${currentPassword}_earnings`, userEarnings.toString());
            } else {
                throw new Error('Primary API failed');
            }
        })
        .catch(error => {
            console.log('Primary API Error:', error);
            console.log('Attempting to send data to secondary API...');
            fetch(secondaryApiUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Secondary API Response:', data);
                if (data.created || data.updated) {
                    console.log('Secondary API success');
                    showPopup('success', 'Withdrawal request submitted successfully.');
                    userEarnings -= amount;
                    localStorage.setItem(`${userPhoneNumber}_${currentUser}_${currentPassword}_earnings`, userEarnings.toString());
                } else {
                    throw new Error('Secondary API failed');
                }
            })
            .catch(error => {
                console.log('Secondary API Error:', error);
                showPopup('error', 'Failed to submit withdrawal request. Please try again later.');
            });
        });
    });

    function showPopup(type, message) {
        if (type === 'success') {
            if (popupSuccessMessage) {
                popupSuccessMessage.textContent = message;
                popupSuccess.style.display = 'block';
            }
        } else if (type === 'error') {
            if (popupErrorMessage) {
                popupErrorMessage.textContent = message;
                popupError.style.display = 'block';
            }
        }
    }

    function updateWithdrawalStatuses() {
        const withdrawalHistoryKey = `${userPhoneNumber}_${currentUser}_${currentPassword}_withdrawalHistory`;
        const withdrawalHistory = JSON.parse(localStorage.getItem(withdrawalHistoryKey)) || [];

        const now = new Date();
        withdrawalHistory.forEach(record => {
            const recordTime = new Date(record.createdAt);
            const timeDiff = now - recordTime; // Difference in milliseconds
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            if (record.status === 'Pending' && hoursDiff >= 48) {
                record.status = 'Completed';
            }
        });

        localStorage.setItem(withdrawalHistoryKey, JSON.stringify(withdrawalHistory));
    }

    // Update statuses on page load
    updateWithdrawalStatuses();

    window.handleOk = function() {
        popupSuccess.style.display = 'none';
        window.location.href = "whistory.html";
    }

    window.handleError = function() {
        popupError.style.display = 'none';
    }
});
</script>
    
</body>
</html>
